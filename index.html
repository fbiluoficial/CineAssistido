<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Lista de Assistidos v2</title>
    
    <!-- Favicon Personalizado -->
    <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQTBlTy-ybk5_1hes7D5xLZTs4pMXUFCdSlCUYMouxllHfORJKOTNBAM2kk&s=10">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilo base com a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Fundo escuro base */
        }
        /* Efeito de vidro para elementos */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom scrollbar for modals */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <!-- Fundo com gradiente -->
    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-gray-900 opacity-60 z-0"></div>

    <div class="relative container mx-auto p-4 md:p-8 z-10">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 flex items-center justify-center gap-3">
                <i data-lucide="tv"></i> Minha Lista de Assistidos
            </h1>
            <p class="text-purple-300">Organize seus animes, filmes e séries favoritos</p>
        </header>

        <!-- Estatísticas -->
        <section id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glassmorphism p-4 rounded-xl text-center">
                <p class="text-3xl font-bold text-white" id="totalAnimes">0</p>
                <p class="text-sm text-purple-300">Animes</p>
            </div>
            <div class="glassmorphism p-4 rounded-xl text-center">
                <p class="text-3xl font-bold text-white" id="totalFilmes">0</p>
                <p class="text-sm text-purple-300">Filmes</p>
            </div>
            <div class="glassmorphism p-4 rounded-xl text-center">
                <p class="text-3xl font-bold text-white" id="totalSeries">0</p>
                <p class="text-sm text-purple-300">Séries</p>
            </div>
            <div class="glassmorphism p-4 rounded-xl text-center bg-white/10">
                <p class="text-3xl font-bold text-white" id="totalItems">0</p>
                <p class="text-sm text-purple-300">Total</p>
            </div>
        </section>

        <!-- Formulário de Adição -->
        <section class="glassmorphism p-6 rounded-2xl mb-8">
            <h2 class="text-2xl font-semibold text-white mb-4 flex items-center gap-2">
                <i data-lucide="plus-circle"></i> Adicionar Novo Item
            </h2>
            <form id="addForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="form-group">
                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Nome *</label>
                        <input type="text" id="name" required class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>
                    <div class="form-group">
                        <label for="type" class="block text-sm font-medium text-gray-300 mb-1">Tipo *</label>
                        <select id="type" required class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="">Selecione...</option>
                            <option value="anime">Anime</option>
                            <option value="filme">Filme</option>
                            <option value="serie">Série</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="year" class="block text-sm font-medium text-gray-300 mb-1">Ano</label>
                        <input type="number" id="year" min="1900" max="2030" class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>
                    <div class="form-group">
                        <label for="rating" class="block text-sm font-medium text-gray-300 mb-1">Nota (1-10)</label>
                        <input type="number" id="rating" min="1" max="10" step="0.1" class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>
                </div>

                <div id="seriesOptions" class="hidden bg-black/20 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-white mb-3">Opções para Séries</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="form-group">
                            <label for="seasons" class="block text-sm font-medium text-gray-300 mb-1">Temporadas</label>
                            <input type="number" id="seasons" min="1" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                        </div>
                        <div class="form-group">
                            <label for="episodes" class="block text-sm font-medium text-gray-300 mb-1">Episódios Totais</label>
                            <input type="number" id="episodes" min="1" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                        </div>
                        <div class="form-group">
                            <label for="watchedEpisodes" class="block text-sm font-medium text-gray-300 mb-1">Episódios Assistidos</label>
                            <input type="number" id="watchedEpisodes" min="0" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                        </div>
                        <div class="form-group">
                            <label for="status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                            <select id="status" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                                <option value="assistindo">Assistindo</option>
                                <option value="completo">Completo</option>
                                <option value="pausado">Pausado</option>
                                <option value="abandonado">Abandonado</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="addBtn" class="mt-4 w-full md:w-auto flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-6 rounded-lg transition-all duration-300 transform hover:scale-105">
                    <i data-lucide="plus"></i> Adicionar à Lista
                </button>
            </form>
        </section>

        <!-- Filtros e Pesquisa -->
        <section class="flex flex-col md:flex-row gap-4 mb-8">
            <div class="flex-1 relative">
                 <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                 <input type="text" id="searchBox" placeholder="Pesquisar por nome..." class="w-full glassmorphism pl-10 pr-4 py-2.5 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div id="filter-buttons" class="flex items-center gap-2 p-1 glassmorphism rounded-lg">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="anime">Animes</button>
                <button class="filter-btn" data-filter="filme">Filmes</button>
                <button class="filter-btn" data-filter="serie">Séries</button>
            </div>
            <style>
              .filter-btn {
                padding: 0.5rem 1rem;
                border-radius: 0.375rem;
                transition: all 0.2s ease-in-out;
                font-weight: 500;
                color: #d1d5db; /* gray-300 */
              }
              .filter-btn:hover {
                background-color: rgba(255, 255, 255, 0.1);
                color: #fff;
              }
              .filter-btn.active {
                background-color: #7c3aed; /* purple-600 */
                color: #fff;
              }
            </style>
        </section>

        <!-- Grade de Cards -->
        <main id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Os cards serão inseridos aqui pelo JavaScript -->
        </main>

    </div>

    <!-- Modal de Edição -->
    <div id="editModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content glassmorphism rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <i data-lucide="x-circle"></i>
            </button>
            <h2 class="text-2xl font-semibold text-white mb-4 flex items-center gap-2">
                <i data-lucide="edit"></i> Editar Item
            </h2>
             <form id="editForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="form-group">
                        <label for="editName" class="block text-sm font-medium text-gray-300 mb-1">Nome *</label>
                        <input type="text" id="editName" required class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>
                    <div class="form-group">
                        <label for="editType" class="block text-sm font-medium text-gray-300 mb-1">Tipo *</label>
                        <select id="editType" required class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="anime">Anime</option>
                            <option value="filme">Filme</option>
                            <option value="serie">Série</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editYear" class="block text-sm font-medium text-gray-300 mb-1">Ano</label>
                        <input type="number" id="editYear" min="1900" max="2030" class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>
                    <div class="form-group">
                        <label for="editRating" class="block text-sm font-medium text-gray-300 mb-1">Nota (1-10)</label>
                        <input type="number" id="editRating" min="1" max="10" step="0.1" class="w-full bg-gray-800 border-gray-600 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>
                </div>

                <div id="editSeriesOptions" class="hidden bg-black/20 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-white mb-3">Opções para Séries</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="form-group"><label for="editSeasons" class="block text-sm font-medium text-gray-300 mb-1">Temporadas</label><input type="number" id="editSeasons" min="1" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition"></div>
                        <div class="form-group"><label for="editEpisodes" class="block text-sm font-medium text-gray-300 mb-1">Episódios Totais</label><input type="number" id="editEpisodes" min="1" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition"></div>
                        <div class="form-group"><label for="editWatchedEpisodes" class="block text-sm font-medium text-gray-300 mb-1">Episódios Assistidos</label><input type="number" id="editWatchedEpisodes" min="0" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition"></div>
                        <div class="form-group"><label for="editStatus" class="block text-sm font-medium text-gray-300 mb-1">Status</label><select id="editStatus" class="w-full bg-gray-700 border-gray-500 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500 transition"><option value="assistindo">Assistindo</option><option value="completo">Completo</option><option value="pausado">Pausado</option><option value="abandonado">Abandonado</option></select></div>
                    </div>
                </div>
                <button type="submit" class="mt-4 w-full md:w-auto flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-6 rounded-lg transition-all duration-300">
                    <i data-lucide="save"></i> Salvar Alterações
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação para Exclusão -->
    <div id="confirmModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="glassmorphism rounded-2xl w-full max-w-sm p-6 text-center">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center">
                    <i data-lucide="trash-2" class="text-red-500 w-8 h-8"></i>
                </div>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Excluir Item</h3>
            <p class="text-gray-300 mb-6">Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="py-2 px-6 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">Cancelar</button>
                <button id="confirmDeleteBtn" class="py-2 px-6 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">Excluir</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIÁVEIS GLOBAIS ---
            let watchList = [];
            let editingId = null;
            let itemToDeleteId = null;
            let currentFilter = 'all';
            let searchTerm = '';

            // --- SELETORES DE ELEMENTOS DOM ---
            const dom = {
                addForm: document.getElementById('addForm'),
                addBtn: document.getElementById('addBtn'),
                typeSelect: document.getElementById('type'),
                seriesOptions: document.getElementById('seriesOptions'),
                watchedEpisodesInput: document.getElementById('watchedEpisodes'),
                episodesInput: document.getElementById('episodes'),
                filterButtonsContainer: document.getElementById('filter-buttons'),
                searchBox: document.getElementById('searchBox'),
                cardsGrid: document.getElementById('cardsGrid'),
                editModal: document.getElementById('editModal'),
                editForm: document.getElementById('editForm'),
                editTypeSelect: document.getElementById('editType'),
                editSeriesOptions: document.getElementById('editSeriesOptions'),
                editWatchedEpisodesInput: document.getElementById('editWatchedEpisodes'),
                editEpisodesInput: document.getElementById('editEpisodes'),
                confirmModal: document.getElementById('confirmModal'),
                cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
                confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            };

            // --- FUNÇÕES DE LÓGICA PRINCIPAL ---

            const saveToStorage = () => {
                if (isLocalStorageAvailable()) {
                    try {
                        localStorage.setItem('watchListV2', JSON.stringify(watchList));
                    } catch (e) { console.warn('Erro ao salvar no localStorage:', e); }
                }
            };

            const loadFromStorage = () => {
                if (isLocalStorageAvailable()) {
                    try {
                        const stored = localStorage.getItem('watchListV2');
                        watchList = stored ? JSON.parse(stored) : [];
                    } catch (e) {
                        console.warn('Erro ao carregar do localStorage:', e);
                        watchList = [];
                    }
                } else {
                    console.info('localStorage não disponível.');
                    watchList = [];
                }
            };

            const updateStats = () => {
                const stats = {
                    total: watchList.length,
                    animes: watchList.filter(item => item.type === 'anime').length,
                    filmes: watchList.filter(item => item.type === 'filme').length,
                    series: watchList.filter(item => item.type === 'serie').length
                };
                document.getElementById('totalItems').textContent = stats.total;
                document.getElementById('totalAnimes').textContent = stats.animes;
                document.getElementById('totalFilmes').textContent = stats.filmes;
                document.getElementById('totalSeries').textContent = stats.series;
            };
            
            const renderCards = () => {
                let filteredList = watchList;

                if (currentFilter !== 'all') {
                    filteredList = filteredList.filter(item => item.type === currentFilter);
                }

                if (searchTerm) {
                    filteredList = filteredList.filter(item =>
                        item.name.toLowerCase().includes(searchTerm)
                    );
                }

                if (filteredList.length === 0) {
                    dom.cardsGrid.innerHTML = `
                        <div class="col-span-1 md:col-span-2 lg:col-span-3 xl:col-span-4 text-center py-16 glassmorphism rounded-2xl">
                            <i data-lucide="folder-search" class="mx-auto w-16 h-16 text-purple-400 mb-4"></i>
                            <h3 class="text-xl font-semibold text-white">Nenhum item encontrado</h3>
                            <p class="text-gray-400 mt-1">${searchTerm ? 'Tente uma pesquisa diferente' : 'Adicione seus primeiros títulos no formulário acima!'}</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                const typeStyles = {
                    anime: { bg: 'bg-orange-500/20', text: 'text-orange-300', icon: 'tv' },
                    filme: { bg: 'bg-blue-500/20', text: 'text-blue-300', icon: 'film' },
                    serie: { bg: 'bg-green-500/20', text: 'text-green-300', icon: 'clapperboard' }
                };

                const statusInfo = {
                    assistindo: { icon: 'play-circle', color: 'text-blue-400' },
                    completo: { icon: 'check-circle-2', color: 'text-green-400' },
                    pausado: { icon: 'pause-circle', color: 'text-yellow-400' },
                    abandonado: { icon: 'x-circle', color: 'text-red-400' }
                };

                dom.cardsGrid.innerHTML = filteredList.map(item => `
                    <div class="glassmorphism rounded-2xl p-5 flex flex-col transition-transform duration-300 hover:transform hover:-translate-y-1 hover:border-purple-500">
                        <div class="flex-grow">
                            <!-- Card Header -->
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-xl font-bold text-white pr-2">${item.name}</h3>
                                <span class="flex-shrink-0 text-xs font-semibold px-3 py-1 rounded-full ${typeStyles[item.type].bg} ${typeStyles[item.type].text} flex items-center gap-1.5">
                                    <i data-lucide="${typeStyles[item.type].icon}" class="w-3.5 h-3.5"></i>
                                    ${capitalizeFirst(item.type)}
                                </span>
                            </div>

                            <!-- Card Info Grid -->
                            <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                                ${item.year ? infoItem('calendar', 'Ano', item.year) : ''}
                                ${item.rating ? infoItem('star', 'Nota', item.rating) : ''}
                                ${item.dateAdded ? infoItem('plus-square', 'Adicionado', item.dateAdded) : ''}
                                ${item.type === 'serie' && item.status ? infoItem(statusInfo[item.status].icon, 'Status', `<span class="${statusInfo[item.status].color}">${capitalizeFirst(item.status)}</span>`) : ''}
                                ${item.type === 'serie' && item.episodes ? infoItem('hash', 'Episódios', `${item.watchedEpisodes || 0}/${item.episodes}`) : ''}
                            </div>
                        </div>
                        
                        <!-- Card Actions -->
                        <div class="flex gap-2 mt-auto pt-4">
                            <button onclick="window.app.editItem(${item.id})" class="flex-1 text-sm flex items-center justify-center gap-2 py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg transition-colors"><i data-lucide="edit-3" class="w-4 h-4"></i> Editar</button>
                            <button onclick="window.app.deleteItem(${item.id})" class="flex-1 text-sm flex items-center justify-center gap-2 py-2 px-3 bg-red-500/20 hover:bg-red-500/40 text-red-300 rounded-lg transition-colors"><i data-lucide="trash" class="w-4 h-4"></i> Excluir</button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons(); // Renderizar os novos ícones
            };
            
            // --- FUNÇÕES AUXILIARES ---
            const infoItem = (icon, label, value) => `
                <div class="flex items-center gap-2 text-gray-300">
                    <i data-lucide="${icon}" class="w-4 h-4 text-purple-400 flex-shrink-0"></i>
                    <div>
                        <p class="font-semibold text-white">${value}</p>
                    </div>
                </div>`;
            
            const isLocalStorageAvailable = () => {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) { return false; }
            };

            const capitalizeFirst = str => str.charAt(0).toUpperCase() + str.slice(1);
            
            const toggleSeriesOptions = (selectElement, optionsContainer) => {
                optionsContainer.style.display = selectElement.value === 'serie' ? 'block' : 'none';
            };

            const validateWatchedEpisodes = (watchedInput, totalInput) => {
                const total = parseInt(totalInput.value) || 0;
                const watched = parseInt(watchedInput.value) || 0;
                if (total > 0 && watched > total) {
                    watchedInput.value = total;
                }
            };
            
            const showFeedback = (button, message, isSuccess) => {
                const originalContent = button.innerHTML;
                const originalClasses = button.className;
                
                button.innerHTML = `<i data-lucide="${isSuccess ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i> ${message}`;
                button.className = `${originalClasses.replace(/bg-\w+-600/, '')} ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
                lucide.createIcons();
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.className = originalClasses;
                    lucide.createIcons();
                }, 2500);
            };

            // --- FUNÇÕES DE MODAL ---
            const openEditModal = (item) => {
                editingId = item.id;
                dom.editForm.elements.editName.value = item.name;
                dom.editForm.elements.editType.value = item.type;
                dom.editForm.elements.editYear.value = item.year || '';
                dom.editForm.elements.editRating.value = item.rating || '';
                
                toggleSeriesOptions(dom.editTypeSelect, dom.editSeriesOptions);

                if (item.type === 'serie') {
                    dom.editForm.elements.editSeasons.value = item.seasons || '';
                    dom.editForm.elements.editEpisodes.value = item.episodes || '';
                    dom.editForm.elements.editWatchedEpisodes.value = item.watchedEpisodes || '';
                    dom.editForm.elements.editStatus.value = item.status || 'assistindo';
                }
                dom.editModal.classList.remove('hidden');
            };

            const closeEditModal = () => {
                dom.editModal.classList.add('hidden');
                editingId = null;
            };

            const openConfirmModal = (id) => {
                itemToDeleteId = id;
                dom.confirmModal.classList.remove('hidden');
            };
            
            const closeConfirmModal = () => {
                dom.confirmModal.classList.add('hidden');
                itemToDeleteId = null;
            };
            
            // --- EVENT LISTENERS ---
            
            dom.addForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target.elements;
                const item = {
                    id: Date.now(),
                    name: form.name.value,
                    type: form.type.value,
                    year: form.year.value,
                    rating: form.rating.value,
                    dateAdded: new Date().toLocaleDateString('pt-BR')
                };

                if (item.type === 'serie') {
                    item.seasons = form.seasons.value;
                    item.episodes = form.episodes.value;
                    item.watchedEpisodes = form.watchedEpisodes.value;
                    item.status = form.status.value;
                }

                watchList.unshift(item); // Adiciona no início da lista
                saveToStorage();
                dom.addForm.reset();
                toggleSeriesOptions(dom.typeSelect, dom.seriesOptions);
                renderCards();
                updateStats();
                showFeedback(dom.addBtn, 'Adicionado!', true);
            });

            dom.editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemIndex = watchList.findIndex(i => i.id === editingId);
                if (itemIndex === -1) return;

                const form = e.target.elements;
                const item = watchList[itemIndex];
                
                item.name = form.editName.value;
                item.type = form.editType.value;
                item.year = form.editYear.value;
                item.rating = form.editRating.value;

                if (item.type === 'serie') {
                    item.seasons = form.editSeasons.value;
                    item.episodes = form.editEpisodes.value;
                    item.watchedEpisodes = form.editWatchedEpisodes.value;
                    item.status = form.editStatus.value;
                }

                saveToStorage();
                closeEditModal();
                renderCards();
                updateStats();
            });

            dom.typeSelect.addEventListener('change', () => toggleSeriesOptions(dom.typeSelect, dom.seriesOptions));
            dom.editTypeSelect.addEventListener('change', () => toggleSeriesOptions(dom.editTypeSelect, dom.editSeriesOptions));

            dom.watchedEpisodesInput.addEventListener('input', () => validateWatchedEpisodes(dom.watchedEpisodesInput, dom.episodesInput));
            dom.editWatchedEpisodesInput.addEventListener('input', () => validateWatchedEpisodes(dom.editWatchedEpisodesInput, dom.editEpisodesInput));

            dom.filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    dom.filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderCards();
                }
            });

            dom.searchBox.addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderCards();
            });

            dom.confirmDeleteBtn.addEventListener('click', () => {
                watchList = watchList.filter(item => item.id !== itemToDeleteId);
                saveToStorage();
                closeConfirmModal();
                renderCards();
                updateStats();
            });
            dom.cancelDeleteBtn.addEventListener('click', closeConfirmModal);

            // --- INICIALIZAÇÃO ---
            const init = () => {
                loadFromStorage();
                updateStats();
                renderCards();
                
                window.app = {
                    editItem: (id) => {
                        const item = watchList.find(i => i.id === id);
                        if (item) openEditModal(item);
                    },
                    deleteItem: (id) => {
                        openConfirmModal(id);
                    }
                };
                window.closeEditModal = closeEditModal;

                dom.editModal.addEventListener('click', (e) => {
                   if (e.target === dom.editModal) closeEditModal();
                });
                dom.confirmModal.addEventListener('click', (e) => {
                   if (e.target === dom.confirmModal) closeConfirmModal();
                });
            };

            init();
        });
    </script>
</body>
</html>

